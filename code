import pyodbc
import pymysql

# SQL Server connection
connection_string = (
    'DRIVER={ODBC Driver 18 for SQL Server};'
    'SERVER=TABISH\\SQLEXPRESS04;'
    'DATABASE=Tabish;'
    'Trusted_Connection=yes;'
    'TrustServerCertificate=yes;'
)

sqlserver_conn = pyodbc.connect(connection_string)
sql_cursor = sqlserver_conn.cursor()

# MySQL connection
mysql_conn = pymysql.connect(
    host='localhost',
    user='root',
    password='root',
    database='newdb'
)
mysql_cursor = mysql_conn.cursor()

print("Connected successfully!")

def get_all_tables(cursor):
    """Get all user tables from SQL Server"""
    query = """
    SELECT TABLE_SCHEMA, TABLE_NAME 
    FROM INFORMATION_SCHEMA.TABLES 
    WHERE TABLE_TYPE = 'BASE TABLE' 
    AND TABLE_SCHEMA NOT IN ('sys', 'INFORMATION_SCHEMA')
    ORDER BY TABLE_SCHEMA, TABLE_NAME
    """
    cursor.execute(query)
    return cursor.fetchall()

def sqlserver_to_mysql_type(sql_type, size, precision, scale):
    """Convert SQL Server data types to MySQL data types"""
    sql_type = sql_type.upper()
    
    type_mapping = {
        'INT': 'INT',
        'BIGINT': 'BIGINT',
        'SMALLINT': 'SMALLINT',
        'TINYINT': 'TINYINT',
        'BIT': 'TINYINT(1)',
        'DECIMAL': f'DECIMAL({precision},{scale})' if precision else 'DECIMAL(10,2)',
        'NUMERIC': f'DECIMAL({precision},{scale})' if precision else 'DECIMAL(10,2)',
        'MONEY': 'DECIMAL(19,4)',
        'SMALLMONEY': 'DECIMAL(10,4)',
        'FLOAT': 'DOUBLE',
        'REAL': 'FLOAT',
        'DATETIME': 'DATETIME',
        'DATETIME2': 'DATETIME',
        'SMALLDATETIME': 'DATETIME',
        'DATE': 'DATE',
        'TIME': 'TIME',
        'TIMESTAMP': 'TIMESTAMP',
        'CHAR': f'CHAR({size})' if size else 'CHAR(255)',
        'VARCHAR': f'VARCHAR({size if size != -1 else 65535})',
        'TEXT': 'TEXT',
        'NCHAR': f'CHAR({size})' if size else 'CHAR(255)',
        'NVARCHAR': f'VARCHAR({size if size != -1 else 65535})',
        'NTEXT': 'TEXT',
        'BINARY': f'BINARY({size})' if size else 'BINARY(255)',
        'VARBINARY': f'VARBINARY({size if size != -1 else 65535})',
        'IMAGE': 'LONGBLOB',
        'UNIQUEIDENTIFIER': 'CHAR(36)',
        'XML': 'TEXT',
    }
    
    return type_mapping.get(sql_type, 'VARCHAR(255)')

def get_table_schema(cursor, schema_name, table_name):
    """Get table schema from SQL Server"""
    query = """
    SELECT 
        c.COLUMN_NAME,
        c.DATA_TYPE,
        c.CHARACTER_MAXIMUM_LENGTH,
        c.NUMERIC_PRECISION,
        c.NUMERIC_SCALE,
        c.IS_NULLABLE,
        CASE WHEN pk.COLUMN_NAME IS NOT NULL THEN 1 ELSE 0 END AS IS_PRIMARY_KEY
    FROM 
        INFORMATION_SCHEMA.COLUMNS c
    LEFT JOIN 
        INFORMATION_SCHEMA.TABLE_CONSTRAINTS tc 
        ON c.TABLE_NAME = tc.TABLE_NAME 
        AND c.TABLE_SCHEMA = tc.TABLE_SCHEMA
        AND tc.CONSTRAINT_TYPE = 'PRIMARY KEY'
    LEFT JOIN 
        INFORMATION_SCHEMA.KEY_COLUMN_USAGE pk 
        ON c.COLUMN_NAME = pk.COLUMN_NAME 
        AND c.TABLE_NAME = pk.TABLE_NAME 
        AND c.TABLE_SCHEMA = pk.TABLE_SCHEMA
        AND tc.CONSTRAINT_NAME = pk.CONSTRAINT_NAME
    WHERE 
        c.TABLE_SCHEMA = ?
        AND c.TABLE_NAME = ?
    ORDER BY 
        c.ORDINAL_POSITION
    """
    
    cursor.execute(query, schema_name, table_name)
    return cursor.fetchall()

def get_row_count(cursor, schema_name, table_name):
    """Get row count for a table"""
    query = f"SELECT COUNT(*) FROM [{schema_name}].[{table_name}]"
    cursor.execute(query)
    return cursor.fetchone()[0]

def create_mysql_table(mysql_cursor, table_name, schema):
    """Create table in MySQL based on SQL Server schema"""
    columns_def = []
    primary_keys = []
    
    for col in schema:
        col_name = col[0]
        data_type = col[1]
        char_max_length = col[2]
        numeric_precision = col[3]
        numeric_scale = col[4]
        is_nullable = col[5]
        is_primary_key = col[6]
        
        # Convert data type
        mysql_type = sqlserver_to_mysql_type(data_type, char_max_length, numeric_precision, numeric_scale)
        
        # Build column definition
        col_def = f"`{col_name}` {mysql_type}"
        
        # Add NOT NULL constraint
        if is_nullable == 'NO':
            col_def += " NOT NULL"
        
        columns_def.append(col_def)
        
        # Track primary keys
        if is_primary_key:
            primary_keys.append(f"`{col_name}`")
    
    # Add primary key constraint
    if primary_keys:
        columns_def.append(f"PRIMARY KEY ({', '.join(primary_keys)})")
    
    # Create the CREATE TABLE statement
    create_table_query = f"CREATE TABLE IF NOT EXISTS `{table_name}` (\n  " + ",\n  ".join(columns_def) + "\n)"
    
    # Drop and create table
    mysql_cursor.execute(f"DROP TABLE IF EXISTS `{table_name}`")
    mysql_cursor.execute(create_table_query)
    
    return create_table_query

def migrate_table_data(sql_cursor, mysql_cursor, mysql_conn, schema_name, table_name):
    """Migrate data from SQL Server to MySQL"""
    # Fetch data
    query = f"SELECT * FROM [{schema_name}].[{table_name}]"
    sql_cursor.execute(query)
    rows = sql_cursor.fetchall()
    
    if not rows:
        return 0
    
    # Get column names
    columns = [column[0] for column in sql_cursor.description]
    
    # Create insert query
    placeholders = ', '.join(['%s'] * len(columns))
    column_names = ', '.join([f'`{col}`' for col in columns])
    insert_query = f"INSERT INTO `{table_name}` ({column_names}) VALUES ({placeholders})"
    
    # Insert data
    success_count = 0
    failed_rows = []
    
    for idx, row in enumerate(rows):
        try:
            row_data = [val for val in row]
            mysql_cursor.execute(insert_query, row_data)
            success_count += 1
        except Exception as e:
            failed_rows.append((idx + 1, str(e)))
            if len(failed_rows) <= 3:  # Show first 3 errors only
                print(f"  ‚ö†Ô∏è  Error on row {idx + 1}: {e}")
    
    mysql_conn.commit()
    return success_count

# Main migration process
print("\n" + "="*70)
print("DISCOVERING TABLES IN SQL SERVER")
print("="*70)

tables = get_all_tables(sql_cursor)

if not tables:
    print("No tables found!")
    exit()

print(f"\nFound {len(tables)} table(s) to migrate:\n")

# Display all tables with row counts
table_info = []
for schema_name, table_name in tables:
    row_count = get_row_count(sql_cursor, schema_name, table_name)
    table_info.append((schema_name, table_name, row_count))
    print(f"  ‚Ä¢ [{schema_name}].[{table_name}] - {row_count:,} rows")

print("\n" + "="*70)
print("STARTING MIGRATION")
print("="*70 + "\n")

# Migrate each table
total_tables = len(table_info)
successful_tables = 0
total_rows_migrated = 0

for idx, (schema_name, table_name, row_count) in enumerate(table_info, 1):
    print(f"\n[{idx}/{total_tables}] Migrating: [{schema_name}].[{table_name}]")
    print("-" * 70)
    
    try:
        # Get schema
        schema = get_table_schema(sql_cursor, schema_name, table_name)
        
        if not schema:
            print(f"  ‚ùå Could not read schema for {table_name}")
            continue
        
        # Create table in MySQL
        print(f"  üìã Creating table structure...")
        create_query = create_mysql_table(mysql_cursor, table_name, schema)
        mysql_conn.commit()
        print(f"  ‚úÖ Table created")
        
        # Migrate data
        if row_count > 0:
            print(f"  üì¶ Migrating {row_count:,} rows...")
            migrated_count = migrate_table_data(sql_cursor, mysql_cursor, mysql_conn, schema_name, table_name)
            print(f"  ‚úÖ Migrated {migrated_count:,}/{row_count:,} rows")
            total_rows_migrated += migrated_count
        else:
            print(f"  ‚ÑπÔ∏è  No data to migrate (empty table)")
        
        successful_tables += 1
        
    except Exception as e:
        print(f"  ‚ùå Failed to migrate {table_name}: {e}")

# Summary
print("\n" + "="*70)
print("MIGRATION SUMMARY")
print("="*70)
print(f"‚úÖ Successfully migrated: {successful_tables}/{total_tables} tables")
print(f"üìä Total rows migrated: {total_rows_migrated:,}")
print(f"‚ùå Failed: {total_tables - successful_tables} tables")

# Verify in MySQL
print("\n" + "="*70)
print("VERIFICATION - Tables in MySQL")
print("="*70)

mysql_cursor.execute("SHOW TABLES")
mysql_tables = mysql_cursor.fetchall()

for table in mysql_tables:
    table_name = table[0]
    mysql_cursor.execute(f"SELECT COUNT(*) FROM `{table_name}`")
    count = mysql_cursor.fetchone()[0]
    print(f"  ‚Ä¢ {table_name}: {count:,} rows")

# Close connections
sql_cursor.close()
sqlserver_conn.close()
mysql_cursor.close()
mysql_conn.close()

print("\n‚úÖ Migration completed!")
